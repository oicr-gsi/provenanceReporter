{% extends 'project_base.html' %}


{% block link %}
 <a href="{{ url_for('project_page', project_name=project['project_id']) }}">{{ project['project_id'] }}</a>
 <a href="{{ url_for('sequencing', project_name=project['project_id']) }}">Sequencing</a> 
 {% for i in pipelines %}
   {% if i in routes %}
     {% if i == 'Whole Genome' %}
       <a href="{{ url_for(routes[i], project_name=project['project_id']) }}">{{i}}</a>
     {% endif %}   
   {% else %}
       <a href="#{{i}}">{{i}}</a>
   {% endif %}  
 {% endfor %}   
 <a class="split" href="{{ miso_link }}" target="_blank">{{ sample_case }}</a> 

{% endblock %}


{% block content %}
  <div class="project_title">
    <p><span style="font-size:30px; font-style:normal;"> Somatic callers analysis blocks </span></p>  
    <p><span style="font-size:16px; font-style:normal;"> An analysis block includes parent call-ready workflows and all downstream caller-workflows</span></p>  
  </div> 

  {% for block in names %}
     <div class="somatic_block">

      <table id="block_header_table">
        
        <tr>
          <td><span style="font-size:22px; font-style:bold;">{{ block.1 }}</span></td>
          <td>Date: {{block_date[block.0]}} </td>
          {% if complete[block.0] %}
            <td>Complete: <span style="font-size:32px;color:#70db70">&#10004;</span></td>
          {% else %}
            <td>Complete: <span style="font-size:32px;color:#ff3300;">&#10006;</span></td>
          {% endif %}
          {% if release_status[block.0] %}
            <td>Release Status: <span style="font-size:32px;color:#70db70">&#10004;</span></td>
          {% else %}
            <td>Release Status: <span style="font-size:32px;color:#ff3300;">&#10006;</span></td>
          {% endif %}
          <td>Download: TBD</td>
        </tr>
      </table>

     <p style="font-size:22px; font-style:bold;"> Call-ready workflows </p>     

       <table id="block_table">
         <thead>
          <th>workflow_run_id</th>
          <th>workflow</th>
          <th>file count</th>
          <th>lane count</th>
          <th>date</th>      
          <th>samples</th>
        </thead>     
        
        {% for bmpp_run in samples_bmpp[block.0] %}
          <tr>
            <td>{{bmpp_run | shorten_workflow_id}}</td>
            <td>{{samples_bmpp[block.0][bmpp_run]['name']}}</td>
            <td>{{file_counts[bmpp_run]}}</td>
            <td>{{amount_data[bmpp_run]}}</td>
            <td>{{workflow_date[block.0][bmpp_run]}}</td>
            <td>
              <dl>
              {% for i in samples_bmpp[block.0][bmpp_run]['samples']['normal'] %}
                <dt>{{i}}</dt>
              {% endfor %}
              {% for i in samples_bmpp[block.0][bmpp_run]['samples']['tumour'] %}
                <dt>{{i}}</dt> 
              {% endfor %}
            </dl>
            </td>
          </tr>
         {% endfor %}
       </table>
     
     <p style="font-size:22px; font-style:bold;"> Caller workflows </p>

     {% for sample in blocks[block.0] %}
       <p style="font-size:20px; font-style:bold;"> Samples: {{ sample }} </p>
       
       <table id="block_table">
          <thead>
           <th>workflow_run_id</th>
           <th>workflow</th>
           <th>file count</th>
           <th>lane count</th>
           <th>date</th>     
           <th>platform</th>
           </thead>     
       
       {% for d in blocks[block.0][sample] %}
         {% for workflow in d %}
           <tr>
             <td>{{d[workflow]['parent']['wfrun_id'] | shorten_workflow_id}}</td>
             <td>{{d[workflow]['parent']['wf']}}</td>
             <td>{{file_counts[d[workflow]['parent']['wfrun_id']]}}</td>              
             <td>{{amount_data[d[workflow]['parent']['wfrun_id']]}}</td>             
             <td>{{workflow_date[block.0][d[workflow]['parent']['wfrun_id']]}}</td>
             <td>{{d[workflow]['parent']['platform']}}</td>     
           </tr>
           {% if d[workflow]['children'] %}
             {% for k in d[workflow]['children'] %}
               <tr>
                 <td>{{k['wfrun_id'] | shorten_workflow_id}}</td>
                 <td>{{k['wf']}}</td>
                 <td>{{file_counts[k['wfrun_id']]}}</td>
                 <td>{{amount_data[k['wfrun_id']]}}</td>
                 <td>{{workflow_date[block.0][k['wfrun_id']]}}</td>          
                 <td>{{k['platform']}}</td>
               </tr>     
             {% endfor %}         
           {% endif %}
         {% endfor %}    
       {% endfor %}
       </table>
     {% endfor %}  

     <p style="font-size:22px; font-style:bold;"> Workflow relationships: </p>
     <img src="data:image/png;base64,{{figures[block.0]}}" alt="workflow_network" title="workflows" style="padding-right: 8px; padding-left:8px; width:25%; height:25%"/>
     </div>
     <br>
  {% endfor %}
{% endblock %}


