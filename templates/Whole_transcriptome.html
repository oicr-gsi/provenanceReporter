{% extends 'project_base.html' %}


{% block link %}
  <a href="{{ url_for('project_page', project_name=project['project_id']) }}">{{ project['project_id'] }}</a>
  <a href="{{ url_for('sequencing', project_name=project['project_id']) }}">Sequencing</a>
  {% for i in pipelines %}
    {% if i in routes %}
      {% if i == 'Whole Transcriptome' %}
        <a class="selected" href="{{ url_for(routes[i], project_name=project['project_id']) }}">{{i}}</a>
      {% elif i == 'Whole Genome' %}
        <a href="{{ url_for(routes[i], project_name=project['project_id']) }}">{{i}}</a>   
      {% endif %}  
    {% else %}
      <a href="#{{i}}">{{i}}</a>
    {% endif %}  
  {% endfor %}   
{% endblock %}


{% block content %}
  <div class="project_title">
    <p>{% block title %}{{ project['project_id'] }} {% endblock %}
      {% if cases %}
        <span style="font-size:30px; font-style:normal;"> WT workflow data for <span id ="count"> {{ cases|length }} </span> cases</span>
        
        <div class="download-dropdown">
          <button class="download-dropbtn">Download json</button>
            <div class="download-dropdown-content">
              <form method="POST" action ="">
                {% if deliverable == 'selected' %}
                  <label><input type="checkbox" name="deliverable" value="selected" id="deliverable" checked/>selected</label><br>      
                {% else %}
                  <label><input type="checkbox" name="deliverable" value="selected" id="deliverable"/>selected</label><br>      
                {% endif %}
                {% if deliverable == 'standard' %}
                  <label><input type="checkbox" name="deliverable" value="standard" id="deliverable" checked/>standard</label><br>      
                {% else %}
                  <label><input type="checkbox" name="deliverable" value="standard" id="deliverable"/>standard</label><br>      
                {% endif %}
                <button class="select_button" type = "submit" value="submit">Download</button>
              </form>          
            </div>
        </div>  
           
      {% else %}
        <span style="font-size:30px; font-style:normal;"> No cases to display</span>
      {% endif %}  
    </p>   
  </div> 

  {% if cases %}
    <div style="margin-left:auto;margin-right:auto;margin-top:80px;padding-bottom:7px;max-width:300px;position:relative">
      <input type="text" id="search_table"  onkeyup="searchFunction()" placeholder="Search.." title="Type in a keyword">
    </div>

    <table id="wgs_table">
      <thead>
        <th>Cases</th>
        <th>Call-ready workflows</th>
        <th>Downstream workflows</th>
        <th>Samples</th>
        <th>Analysis blocks</th>
        <th>Status</th>
      </thead>     
      
      {% for i in samples %}
        {% if i in block_status %}
          {% set rowNum = block_status[i] | length %}
          {% set myList = block_status[i].keys() | list | sort %}
        {% else %}
          {% set rowNum = 1 %}
          {% set myList = [] %}
        {% endif %}
        
        <tbody>
          <tr>
            <td rowspan="{{rowNum}}">
              <a class="project_links" href="{{ url_for('wt_case', project_name=project['project_id'], case=i)}}">{{i}}</a>
            </td>
            <td rowspan="{{rowNum}}">
              <a class="project_links" href="{{ url_for('wt_case', project_name=project['project_id'], case=i)}}">{{cases[i]['star'] | length}}</a>
            </td>
            <td rowspan="{{rowNum}}">
              <a class="project_links" href="{{ url_for('wt_case', project_name=project['project_id'], case=i)}}">{{cases[i]['downstream'] | length}}</a>
            </td>
            <td>
            {% if myList %}
              <a class="project_links" href="{{ url_for('wt_case', project_name=project['project_id'], case=i)}}">{{myList.0}}</a>
            {% else %}
              <a class="project_links" href="{{ url_for('wt_case', project_name=project['project_id'], case=i)}}">NA</a>
            {% endif %}
            </td>
            <td>
              {% if myList %}
                <a class="project_links" href="{{ url_for('wt_case', project_name=project['project_id'], case=i)}}">{{block_counts[i][myList.0]}}</a>
              {% else %}
                <a class="project_links" href="{{ url_for('wt_case', project_name=project['project_id'], case=i)}}">0</a>
              {% endif %} 
            </td>    
            <td>
              {% if myList %}
                <a class="project_links" href="{{ url_for('wt_case', project_name=project['project_id'], case=i)}}">
                  {% if block_status[i][myList.0] != 'review' and block_status[i][myList.0] != 'ready' %}
                    {{block_status[i][myList.0] | shorten_workflow_id}}
                  {% else %}
                    <button class="review_button">{{block_status[i][myList.0]}}</button>
                  {% endif %}           
                </a>         
              {% else %}
                <a class="project_links" href="{{ url_for('wt_case', project_name=project['project_id'], case=i)}}"> 
                  NA
                </a>
              {% endif %}
            </td> 
          </tr>  
          
          {% if myList %}
            {% for j in myList[1:] %}
              <tr>          
                <td>
                  <a class="project_links" href="{{ url_for('wt_case', project_name=project['project_id'], case=i)}}">
                    {{j}}
                  </a>
                </td>
                <td>
                  <a class="project_links" href="{{ url_for('wt_case', project_name=project['project_id'], case=i)}}">
                    {{block_counts[i][j]}}
                  </a>        
                </td>
                <td>
                  <a class="project_links" href="{{ url_for('wt_case', project_name=project['project_id'], case=i)}}">
                    {% if block_status[i][j] != 'review' and block_status[i][j] != 'ready' %}
                      {{block_status[i][j] | shorten_workflow_id}}
                    {% else %}
                      <button class="review_button">{{block_status[i][j]}}</button>
                    {% endif %}
                  </a>
                </td>
              </tr>
            {% endfor %}
          {% endif %}
        
        </tr>
        </tbody>
      {% endfor %}               
    </table>

<footer>
<p style="margin-left:auto;margin-right:auto; margin-top:150px; padding-bottom:0px;max-width:300px;position:relative;font-size:16px; font-style:normal; font-family: Arial, Helvetica, sans-serif; color: #A8A8A8;"> Data last updated {{project['last_updated'].split('_')[0]}} </p>
</footer>
  
   <script>
   function searchFunction() {
   var input, filter, table, tr, td, i, txtValue;
   var rowCount = 0    
   input = document.getElementById("search_table");
   filter = input.value.toUpperCase();
   table = document.getElementById("project_table");
   tr = table.getElementsByTagName("tr");
   for (i = 1; i < tr.length; i++) {
   td= tr[i];
     if (td) {
       txtValue = td.textContent || td.innerText;
       if (txtValue.toUpperCase().indexOf(filter) > -1) {
         tr[i].style.display = "";
         rowCount++;
       } else {
         tr[i].style.display = "none";
         }
     }       
    }
   document.getElementById("count").innerHTML = rowCount
   }
  </script>

  {% endif %}


   
{% endblock %}
